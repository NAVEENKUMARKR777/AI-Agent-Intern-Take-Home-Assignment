{% extends "base.html" %}

{% block title %}Plan History - AI Task Planning Agent{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-history me-2"></i>Your Plan History</h2>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create New Plan
            </a>
        </div>
        
        <!-- Loading indicator -->
        <div id="loading" class="text-center py-5">
            <div class="spinner"></div>
            <h4>Loading your plans...</h4>
        </div>
        
        <!-- Plans list -->
        <div id="plans-container" style="display: none;">
            <div id="plans-list"></div>
            
            <div id="no-plans" class="text-center py-5" style="display: none;">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No plans yet</h4>
                <p class="text-muted">Create your first plan to get started!</p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Plan
                </a>
            </div>
        </div>
    </div>
</div>

<script>
async function loadPlans() {
    try {
        const response = await fetch('/api/plans');
        const plans = await response.json();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('plans-container').style.display = 'block';
        
        const plansList = document.getElementById('plans-list');
        const noPlans = document.getElementById('no-plans');
        
        if (plans.length === 0) {
            noPlans.style.display = 'block';
            return;
        }
        
        noPlans.style.display = 'none';
        plansList.innerHTML = '';
        
        plans.forEach(plan => {
            const planCard = createPlanCard(plan);
            plansList.appendChild(planCard);
        });
        
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('plans-container').style.display = 'block';
        document.getElementById('plans-list').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading plans: ${error.message}
            </div>
        `;
    }
}

function createPlanCard(plan) {
    const card = document.createElement('div');
    card.className = 'plan-card';
    card.innerHTML = `
        <div class="plan-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h4 class="mb-1">${escapeHtml(plan.goal)}</h4>
                    <small>Created: ${plan.created_at}</small>
                </div>
                <button class="btn btn-sm btn-light" onclick="togglePlan(${plan.id})">
                    <i class="fas fa-chevron-down" id="icon-${plan.id}"></i>
                </button>
            </div>
        </div>
        <div class="plan-content" id="content-${plan.id}" style="display: none;">
            ${escapeHtml(plan.plan_content).replace(/\n/g, '<br>')}
        </div>
    `;
    return card;
}

function togglePlan(planId) {
    const content = document.getElementById(`content-${planId}`);
    const icon = document.getElementById(`icon-${planId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load plans when page loads
document.addEventListener('DOMContentLoaded', loadPlans);
</script>
{% endblock %}
